# CI â€” platform-infra
# Validates K8s manifests, kustomize builds, and YAML structure.

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  kustomize-build:
    name: Kustomize Build
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            objects.githubusercontent.com:443
            agent.api.stepsecurity.io:443

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install kustomize (verified checksum)
        run: |
          KUSTOMIZE_VERSION=v5.4.1
          KUSTOMIZE_SHA256=3d659a80398658d4fec4ec4ca184b432afa1d86451a60be63ca6e14311fc1c42
          curl -sLo kustomize.tar.gz "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2F${KUSTOMIZE_VERSION}/kustomize_${KUSTOMIZE_VERSION}_linux_amd64.tar.gz"
          echo "${KUSTOMIZE_SHA256}  kustomize.tar.gz" | sha256sum -c -
          tar xzf kustomize.tar.gz
          sudo mv kustomize /usr/local/bin/
          rm kustomize.tar.gz

      - name: Build base
        run: kustomize build k8s/base

      - name: Build apps (control-plane)
        run: kustomize build k8s/apps/clinical-agentic-control-plane

      - name: Build apps (workers)
        run: kustomize build k8s/apps/workers

      - name: Build observability
        run: kustomize build k8s/observability

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            objects.githubusercontent.com:443
            agent.api.stepsecurity.io:443
            pypi.org:443
            files.pythonhosted.org:443

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint K8s manifests
        run: |
          yamllint -d "{extends: default, rules: {line-length: {max: 200}, truthy: disable}}" \
            k8s/ argocd/ environments/

  validate-argocd:
    name: Validate ArgoCD Apps
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            objects.githubusercontent.com:443
            agent.api.stepsecurity.io:443

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Validate ArgoCD application manifests (YAML structure)
        run: |
          for f in argocd/applications/*.yaml argocd/projects/*.yaml; do
            echo "Checking $f ..."
            python3 -c "
          import yaml, sys
          with open('$f') as fh:
              doc = yaml.safe_load(fh)
          kind = doc.get('kind', '')
          if kind not in ('Application', 'AppProject'):
              print(f'WARN: {\"$f\"} kind={kind}')
          print(f'OK: {\"$f\"} kind={kind}')
          "
          done
